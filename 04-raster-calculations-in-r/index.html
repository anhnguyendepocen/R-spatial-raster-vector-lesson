<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2018-03-23 15:42:17 +0000">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-dc.ico" />
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Intro to Geospatial Data with R: Raster Calculations in R</title>
  </head>
  <body>
    <div class="container">
      
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="http://datacarpentry.org" class="pull-left">
        <img class="navbar-logo" src="../assets/img/dc-icon-black.svg" alt="Data Carpentry logo" />
      </a>
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

	
        
        <li><a href="../setup/">Setup</a></li>
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-raster-structure/">Intro to Raster Data in R</a></li>
            
            <li><a href="../02-raster-plot/">Plot Raster Data in R</a></li>
            
            <li><a href="../03-raster-reproject-in-r/">Reproject Raster Data in R</a></li>
            
            <li><a href="../04-raster-calculations-in-r/">Raster Calculations in R</a></li>
            
            <li><a href="../05-raster-multi-band-in-r/">Work With Multi-Band Rasters in R</a></li>
            
            <li><a href="../06-vector-open-shapefile-in-r/">Open and Plot Shapefiles in R</a></li>
            
            <li><a href="../07-vector-shapefile-attributes-in-r/">Explore and Plot by Shapefile Attributes</a></li>
            
            <li><a href="../08-vector-plot-shapefiles-custom-legend/">Plot Multiple Shapefiles in R</a></li>
            
            <li><a href="../09-vector-when-data-dont-line-up-crs/">Handling Spatial Projection & CRS in R</a></li>
            
            <li><a href="../10-vector-csv-to-shapefile-in-r/">Convert from .csv to a Shapefile in R</a></li>
            
            <li><a href="../11-vector-raster-integration/">Manipulate Raster Data in R</a></li>
            
            <li><a href="../12-time-series-raster/">Raster Time Series Data in R</a></li>
            
            <li><a href="../13-plot-time-series-rasters-in-r/">Plot Raster Time Series Data in R</a></li>
            
            <li><a href="../14-extract-ndvi-from-rasters-in-r/">Derive Values from Raster Time Series</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio/">All in one page (Beta)</a></li>
          </ul>
        </li>
	

	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference/">Reference</a></li>
            
          </ul>
        </li>
	

	
        <li><a href="../license/">License</a></li>
	
	<li><a href="/edit/gh-pages/_episodes/04-raster-calculations-in-r.md">Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>


<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../03-raster-reproject-in-r/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
    <h3 class="maintitle"><a href="../">Intro to Geospatial Data with R</a></h3>
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../05-raster-multi-band-in-r/"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Raster Calculations in R</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="testimonial">
  <h2>Authors</h2>
    Leah A. Wasser, Megan A. Jones, Zack Brym, Kristina Riemer, Jason Williams, Jeff Hollister, Mike Smorul, Joseph Stachelek
</blockquote>

<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 10 min
      <br/>
      <strong>Exercises:</strong> 0 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How to subtract one raster from another and extract pixel values for defined locations.</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Be able to to perform a subtraction (difference) between two rasters using raster math.</p>
</li>
	
	<li><p>Know how to perform a more efficient subtraction (difference) between two rasters using the raster <code class="highlighter-rouge">overlay()</code> function in R.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<blockquote class="prereq">
  <h2 id="things-youll-need-to-complete-this-tutorial">Things You’ll Need To Complete This Tutorial</h2>

  <p><strong>R Skill Level:</strong> Intermediate - you’ve got the basics of <code class="highlighter-rouge">R</code> down.</p>

  <p>You will need the most current version of <code class="highlighter-rouge">R</code> and, preferably, <code class="highlighter-rouge">RStudio</code> loaded
on your computer to complete this tutorial.</p>

  <h3 id="install-r-packages">Install R Packages</h3>

  <ul>
    <li><strong>raster:</strong> <code class="highlighter-rouge">install.packages("raster")</code></li>
    <li>
      <p><strong>rgdal:</strong> <code class="highlighter-rouge">install.packages("rgdal")</code></p>
    </li>
    <li><a href="/R/Packages-In-R/">More on Packages in R - Adapted from Software Carpentry.</a></li>
  </ul>

  <h4 id="data-to-download">Data to Download</h4>

  <h3 id="additional-resources">Additional Resources</h3>
  <ul>
    <li><a href="http://cran.r-project.org/web/packages/raster/raster.pdf" target="_blank">Read more about the <code class="highlighter-rouge">raster</code> package in <code class="highlighter-rouge">R</code>.</a></li>
  </ul>
</blockquote>

<p>We often want to combine values of and perform calculations on rasters to create
a new output raster. This tutorial covers how to subtract one raster from
another using basic raster math and the <code class="highlighter-rouge">overlay()</code> function. It also covers how
to extract pixel values from a set of locations - for example a buffer region
around plot locations at a field site.</p>

<h2 id="raster-calculations-in-r">Raster Calculations in R</h2>
<p>We often want to perform calculations on two or more rasters to create a new
output raster. For example, if we are interested in mapping the heights of trees
across an entire field site, we might want to calculate the <em>difference</em> between
the Digital Surface Model (DSM, tops of trees) and the
Digital Terrain Model (DTM, ground level). The resulting dataset is referred to
as a Canopy Height Model (CHM) and represents the actual height of trees,
buildings, etc. with the influence of ground elevation removed.</p>

<figure>
    <a href="/images/dc-spatial-raster/lidarTree-height.png">
    <img src="/images/dc-spatial-raster/lidarTree-height.png" />
    </a>
    <figcaption> Source: National Ecological Observatory Network (NEON)
    </figcaption>
</figure>

<ul>
  <li>Check out more on LiDAR CHM, DTM and DSM in this NEON Data Skills overview tutorial:
<a href="http://neondataskills.org/self-paced-tutorial/2_LiDAR-Data-Concepts_Activity2/" target="_blank">
What is a CHM, DSM and DTM? About Gridded, Raster LiDAR Data</a>.</li>
</ul>

<h3 id="load-the-data">Load the Data</h3>
<p>We will need the <code class="highlighter-rouge">raster</code> package to import and perform raster calculations. We
will use the DTM (<code class="highlighter-rouge">NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif</code>)
and DSM (<code class="highlighter-rouge">NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif</code>) from the
NEON Harvard Forest Field site.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load raster package</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Loading required package: sp
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rgdal: version: 1.2-8, (SVN revision 663)
 Geospatial Data Abstraction Library extensions to R successfully loaded
 Loaded GDAL runtime: GDAL 2.2.1, released 2017/06/23
 Path to GDAL shared files: /usr/share/gdal/2.2
 Loaded PROJ.4 runtime: Rel. 4.9.2, 08 September 2015, [PJ_VERSION: 492]
 Path to PROJ.4 shared files: (autodetected)
 Linking to sp version: 1.2-5 
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># view info about the dtm &amp; dsm raster data that we will work with.</span><span class="w">
</span><span class="n">GDALinfo</span><span class="p">(</span><span class="s2">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rows        1367 
columns     1697 
bands       1 
lower left origin.x        731453 
lower left origin.y        4712471 
res.x       1 
res.y       1 
ysign       -1 
oblique.x   0 
oblique.y   0 
driver      GTiff 
projection  +proj=utm +zone=18 +datum=WGS84 +units=m +no_defs 
file        data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif 
apparent band summary:
   GDType hasNoDataValue NoDataValue blockSize1 blockSize2
1 Float64           TRUE       -9999          1       1697
apparent band statistics:
    Bmin   Bmax    Bmean      Bsd
1 304.56 389.82 344.8979 15.86147
Metadata:
AREA_OR_POINT=Area 
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">GDALinfo</span><span class="p">(</span><span class="s2">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rows        1367 
columns     1697 
bands       1 
lower left origin.x        731453 
lower left origin.y        4712471 
res.x       1 
res.y       1 
ysign       -1 
oblique.x   0 
oblique.y   0 
driver      GTiff 
projection  +proj=utm +zone=18 +datum=WGS84 +units=m +no_defs 
file        data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif 
apparent band summary:
   GDType hasNoDataValue NoDataValue blockSize1 blockSize2
1 Float64           TRUE       -9999          1       1697
apparent band statistics:
    Bmin   Bmax    Bmean      Bsd
1 305.07 416.07 359.8531 17.83169
Metadata:
AREA_OR_POINT=Area 
</code></pre></div></div>

<p>As seen from the <code class="highlighter-rouge">geoTiff</code> tags, both rasters have:</p>

<ul>
  <li>the same CRS,</li>
  <li>the same resolution</li>
  <li>defined minimum and maximum values.</li>
</ul>

<p>Let’s load the data.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load the DTM &amp; DSM rasters</span><span class="w">
</span><span class="n">DTM_HARV</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="s2">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif"</span><span class="p">)</span><span class="w">
</span><span class="n">DSM_HARV</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="s2">"data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif"</span><span class="p">)</span><span class="w">

</span><span class="c1"># create a quick plot of each to see what we're dealing with</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">DTM_HARV</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Digital Terrain Model \n NEON Harvard Forest Field Site"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-load-plot-data-1.png" title="plot of chunk load-plot-data" alt="plot of chunk load-plot-data" style="display: block; margin: auto;" /></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plot</span><span class="p">(</span><span class="n">DSM_HARV</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Digital Surface Model \n NEON Harvard Forest Field Site"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-load-plot-data-2.png" title="plot of chunk load-plot-data" alt="plot of chunk load-plot-data" style="display: block; margin: auto;" /></p>

<h2 id="two-ways-to-perform-raster-calculations">Two Ways to Perform Raster Calculations</h2>

<p>We can calculate the difference between two rasters in two different ways:</p>

<ul>
  <li>by directly subtracting the two rasters in <code class="highlighter-rouge">R</code> using raster math</li>
</ul>

<p>or for more efficient processing - particularly if our rasters are large and/or
the calculations we are performing are complex:</p>

<ul>
  <li>using the <code class="highlighter-rouge">overlay()</code> function.</li>
</ul>

<h2 id="raster-math--canopy-height-models">Raster Math &amp; Canopy Height Models</h2>
<p>We can perform raster calculations by simply subtracting (or adding,
multiplying, etc) two rasters. In the geospatial world, we call this
“raster math”.</p>

<p>Let’s subtract the DTM from the DSM to create a Canopy Height Model.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Raster math example</span><span class="w">
</span><span class="n">CHM_HARV</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">DSM_HARV</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">DTM_HARV</span><span class="w">

</span><span class="c1"># plot the output CHM</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Canopy Height Model - Raster Math Subtract\n NEON Harvard Forest Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-raster-math-1.png" title="plot of chunk raster-math" alt="plot of chunk raster-math" style="display: block; margin: auto;" /></p>

<p>Let’s have a look at the distribution of values in our newly created
Canopy Height Model (CHM).</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># histogram of CHM_HARV</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">,</span><span class="w">
  </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen4"</span><span class="p">,</span><span class="w">
  </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Histogram of Canopy Height Model\nNEON Harvard Forest Field Site"</span><span class="p">,</span><span class="w">
  </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of Pixels"</span><span class="p">,</span><span class="w">
  </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Tree Height (m) "</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-create-hist-1.png" title="plot of chunk create-hist" alt="plot of chunk create-hist" style="display: block; margin: auto;" /></p>

<p>Notice that the range of values for the output CHM is between 0 and 30 meters.
Does this make sense for trees in Harvard Forest?</p>

<blockquote class="challenge">
  <h2 id="challenge-explore-chm-raster-values">Challenge: Explore CHM Raster Values</h2>

  <p>It’s often a good idea to explore the range of values in a raster dataset just like we might explore a dataset that we collected in the field.</p>

  <ol>
    <li>What is the min and maximum value for the Harvard Forest Canopy Height Model (<code class="highlighter-rouge">CHM_HARV</code>) that we just created?</li>
    <li>What are two ways you can check this range of data in <code class="highlighter-rouge">CHM_HARV</code>?</li>
    <li>What is the distribution of all the pixel values in the CHM?</li>
    <li>Plot a histogram with 6 bins instead of the default and change the color of the histogram.</li>
    <li>Plot the <code class="highlighter-rouge">CHM_HARV</code> raster using breaks that make sense for the data. Include an appropriate color palette for the data, plot title and no axes ticks / labels.</li>
  </ol>

  <blockquote class="solution">
    <h2 id="answers">Answers</h2>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1)</span><span class="w">
</span><span class="n">minValue</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 0
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">maxValue</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 38.16998
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 2) Looks at histogram, minValue(NAME)/maxValue(NAME), NAME and look at values</span><span class="w">
</span><span class="c1"># slot.</span><span class="w">
</span><span class="c1"># 3</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen4"</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Histogram of Canopy Height Model\nNEON Harvard Forest Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">maxpixels</span><span class="o">=</span><span class="n">ncell</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">))</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-CHM-HARV-1.png" title="plot of chunk challenge-code-CHM-HARV" alt="plot of chunk challenge-code-CHM-HARV" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 4</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"lightgreen"</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Histogram of Canopy Height Model\nNEON Harvard Forest Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">maxpixels</span><span class="o">=</span><span class="n">ncell</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">),</span><span class="w">
     </span><span class="n">breaks</span><span class="o">=</span><span class="m">6</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-CHM-HARV-2.png" title="plot of chunk challenge-code-CHM-HARV" alt="plot of chunk challenge-code-CHM-HARV" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 5</span><span class="w">
</span><span class="n">myCol</span><span class="o">=</span><span class="n">terrain.colors</span><span class="p">(</span><span class="m">4</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">,</span><span class="w">
     </span><span class="n">breaks</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="m">30</span><span class="p">),</span><span class="w">
     </span><span class="n">col</span><span class="o">=</span><span class="n">myCol</span><span class="p">,</span><span class="w">
     </span><span class="n">axes</span><span class="o">=</span><span class="nb">F</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Canopy Height Model \nNEON Harvard Forest Field Site"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-CHM-HARV-3.png" title="plot of chunk challenge-code-CHM-HARV" alt="plot of chunk challenge-code-CHM-HARV" style="display: block; margin: auto;" /></p>
  </blockquote>
</blockquote>

<h2 id="efficient-raster-calculations-overlay-function">Efficient Raster Calculations: Overlay Function</h2>
<p>Raster math, like we just did, is an appropriate approach to raster calculations
if:</p>

<ol>
  <li>The rasters we are using are small in size.</li>
  <li>The calculations we are performing are simple.</li>
</ol>

<p>However, raster math is a less efficient approach as computation becomes more
complex or as file sizes become large.
The <code class="highlighter-rouge">overlay()</code> function is more efficient when:</p>

<ol>
  <li>The rasters we are using are larger in size.</li>
  <li>The rasters are stored as individual files.</li>
  <li>The computations performed are complex.</li>
</ol>

<p>The <code class="highlighter-rouge">overlay()</code> function takes two or more rasters and applies a function to
them using efficient processing methods. The syntax is</p>

<p><code class="highlighter-rouge">outputRaster &lt;- overlay(raster1, raster2, fun=functionName)</code></p>

<blockquote class="callout">
  <h2 id="data-tip">Data Tip</h2>
  <p>If the rasters are stacked and stored
as <code class="highlighter-rouge">RasterStack</code> or <code class="highlighter-rouge">RasterBrick</code> objects in <code class="highlighter-rouge">R</code>, then we should use <code class="highlighter-rouge">calc()</code>.
<code class="highlighter-rouge">overlay()</code> will not work on stacked rasters.</p>
</blockquote>

<p>Let’s perform the same subtraction calculation that we calculated above using
raster math, using the <code class="highlighter-rouge">overlay()</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CHM_ov_HARV</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">overlay</span><span class="p">(</span><span class="n">DSM_HARV</span><span class="p">,</span><span class="w">
                      </span><span class="n">DTM_HARV</span><span class="p">,</span><span class="w">
                      </span><span class="n">fun</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">r</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="m">2</span><span class="p">){</span><span class="nf">return</span><span class="p">(</span><span class="n">r</span><span class="m">1</span><span class="o">-</span><span class="n">r</span><span class="m">2</span><span class="p">)})</span><span class="w">

</span><span class="n">plot</span><span class="p">(</span><span class="n">CHM_ov_HARV</span><span class="p">,</span><span class="w">
  </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Canopy Height Model - Overlay Subtract\n NEON Harvard Forest Field Site"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-raster-overlay-1.png" title="plot of chunk raster-overlay" alt="plot of chunk raster-overlay" style="display: block; margin: auto;" /></p>

<p>How do the plots of the CHM created with manual raster math and the <code class="highlighter-rouge">overlay()</code>
function compare?</p>

<blockquote class="callout">
  <h2 id="data-tip-1">Data Tip</h2>
  <p>A custom function consists of a defined
set of commands performed on a input object. Custom functions are particularly
useful for tasks that need to be repeated over and over in the code. A
simplified syntax for writing a custom function in R is:
<code class="highlighter-rouge">functionName &lt;- function(variable1, variable2){WhatYouWantDone, WhatToReturn}</code></p>
</blockquote>

<h2 id="export-a-geotiff">Export a GeoTIFF</h2>
<p>Now that we’ve created a new raster, let’s export the data as a <code class="highlighter-rouge">GeoTIFF</code> using
the <code class="highlighter-rouge">writeRaster()</code> function.</p>

<p>When we write this raster object to a <code class="highlighter-rouge">GeoTIFF</code> file we’ll name it
<code class="highlighter-rouge">chm_HARV.tiff</code>. This name allows us to quickly remember both what the data
contains (CHM data) and for where (HARVard Forest). The <code class="highlighter-rouge">writeRaster()</code> function
by default writes the output file to your working directory unless you specify a
full file path.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># export CHM object to new GeotIFF</span><span class="w">
</span><span class="n">writeRaster</span><span class="p">(</span><span class="n">CHM_ov_HARV</span><span class="p">,</span><span class="w"> </span><span class="s2">"chm_HARV.tiff"</span><span class="p">,</span><span class="w">
            </span><span class="n">format</span><span class="o">=</span><span class="s2">"GTiff"</span><span class="p">,</span><span class="w">  </span><span class="c1"># specify output format - GeoTIFF</span><span class="w">
            </span><span class="n">overwrite</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="c1"># CAUTION: if this is true, it will overwrite an</span><span class="w">
                            </span><span class="c1"># existing file</span><span class="w">
            </span><span class="n">NAflag</span><span class="o">=</span><span class="m">-9999</span><span class="p">)</span><span class="w"> </span><span class="c1"># set no data value to -9999</span><span class="w">
</span></code></pre></div></div>

<h3 id="writeraster-options">writeRaster Options</h3>
<p>The function arguments that we used above include:</p>

<ul>
  <li><strong>format:</strong> specify that the format will be <code class="highlighter-rouge">GTiff</code> or <code class="highlighter-rouge">GeoTiff</code>.</li>
  <li><strong>overwrite:</strong> If TRUE, <code class="highlighter-rouge">R</code> will overwrite any existing file  with the same
name in the specified directory. USE THIS SETTING WITH CAUTION!</li>
  <li><strong>NAflag:</strong> set the <code class="highlighter-rouge">geotiff</code> tag for <code class="highlighter-rouge">NoDataValue</code> to -9999, the National
Ecological Observatory Network’s (NEON) standard <code class="highlighter-rouge">NoDataValue</code>.</li>
</ul>

<blockquote class="challenge">
  <h2 id="challenge-explore-the-neon-san-joaquin-experimental-range-field-site">Challenge: Explore the NEON San Joaquin Experimental Range Field Site</h2>

  <p>Data are often more interesting and powerful when we compare them across various
locations. Let’s compare some data collected over Harvard Forest to data
collected in Southern California. The
<a href="http://www.neonscience.org/science-design/field-sites/san-joaquin-experimental-range" target="_blank">NEON San Joaquin Experimental Range (SJER) field site </a>
located in Southern California has a very different ecosystem and climate than
the
<a href="http://www.neonscience.org/science-design/field-sites/harvard-forest" target="_blank">NEON Harvard Forest Field Site</a>
in Massachusetts.</p>

  <p>Import the SJER DSM and DTM raster files and create a Canopy Height Model.
Then compare the two sites. Be sure to name your <code class="highlighter-rouge">R</code> objects and outputs
carefully, as follows: objectType_SJER (e.g. <code class="highlighter-rouge">DSM_SJER</code>). This will help you
keep track of data from different sites!</p>

  <ol>
    <li>Import the DSM and DTM from the SJER directory (if not aready imported
in the
<a href="/R/Plot-Rasters-In-R/">Plot Raster Data in R</a>
tutorial.) Don’t forget to examine the data for <code class="highlighter-rouge">CRS</code>, bad values, etc.</li>
    <li>Create a <code class="highlighter-rouge">CHM</code> from the two raster layers and check to make sure the data
are what you expect.</li>
    <li>Plot the <code class="highlighter-rouge">CHM</code> from SJER.</li>
    <li>Export the SJER CHM as a <code class="highlighter-rouge">GeoTIFF</code>.</li>
    <li>Compare the vegetation structure of the Harvard Forest and San Joaquin
Experimental Range.</li>
  </ol>

  <p>Hint: plotting SJER and HARV data side-by-side is an effective way to compare
both datasets!</p>
  <blockquote class="solution">
    <h2 id="answers-1">Answers</h2>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1.</span><span class="w">
</span><span class="c1"># load the DTM</span><span class="w">
</span><span class="n">DTM_SJER</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="s2">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DTM/SJER_dtmCrop.tif"</span><span class="p">)</span><span class="w">
</span><span class="c1"># load the DSM</span><span class="w">
</span><span class="n">DSM_SJER</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">raster</span><span class="p">(</span><span class="s2">"data/NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmCrop.tif"</span><span class="p">)</span><span class="w">

</span><span class="c1"># check CRS, units, etc</span><span class="w">
</span><span class="n">DTM_SJER</span><span class="w">
</span><span class="n">DSM_SJER</span><span class="w">

</span><span class="c1"># check values</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">DTM_SJER</span><span class="p">,</span><span class="w">
     </span><span class="n">maxpixels</span><span class="o">=</span><span class="n">ncell</span><span class="p">(</span><span class="n">DTM_SJER</span><span class="p">),</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Digital Terrain Model - Histogram\n NEON SJER Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"slategrey"</span><span class="p">,</span><span class="w">
     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of Pixels"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Elevation (m)"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-SJER-CHM-1.png" title="plot of chunk challenge-code-SJER-CHM" alt="plot of chunk challenge-code-SJER-CHM" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">hist</span><span class="p">(</span><span class="n">DSM_SJER</span><span class="p">,</span><span class="w">
     </span><span class="n">maxpixels</span><span class="o">=</span><span class="n">ncell</span><span class="p">(</span><span class="n">DSM_SJER</span><span class="p">),</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Digital Surface Model - Histogram\n NEON SJER Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"slategray2"</span><span class="p">,</span><span class="w">
     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of Pixels"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Elevation (m)"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-SJER-CHM-2.png" title="plot of chunk challenge-code-SJER-CHM" alt="plot of chunk challenge-code-SJER-CHM" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 2.</span><span class="w">
</span><span class="c1"># use overlay to subtract the two rasters &amp; create CHM</span><span class="w">
</span><span class="n">CHM_SJER</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">overlay</span><span class="p">(</span><span class="n">DSM_SJER</span><span class="p">,</span><span class="w"> </span><span class="n">DTM_SJER</span><span class="p">,</span><span class="w">
                    </span><span class="n">fun</span><span class="o">=</span><span class="k">function</span><span class="p">(</span><span class="n">r</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="m">2</span><span class="p">){</span><span class="nf">return</span><span class="p">(</span><span class="n">r</span><span class="m">1</span><span class="o">-</span><span class="n">r</span><span class="m">2</span><span class="p">)})</span><span class="w">

</span><span class="n">hist</span><span class="p">(</span><span class="n">CHM_SJER</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Canopy Height Model - Histogram\n NEON SJER Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen4"</span><span class="p">,</span><span class="w">
     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of Pixels"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Elevation (m)"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-SJER-CHM-3.png" title="plot of chunk challenge-code-SJER-CHM" alt="plot of chunk challenge-code-SJER-CHM" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 3</span><span class="w">
</span><span class="c1"># plot the output</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">CHM_SJER</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Canopy Height Model - Overlay Subtract\n NEON SJER Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">axes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-SJER-CHM-4.png" title="plot of chunk challenge-code-SJER-CHM" alt="plot of chunk challenge-code-SJER-CHM" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 4</span><span class="w">
</span><span class="c1"># Write to object to file</span><span class="w">
</span><span class="n">writeRaster</span><span class="p">(</span><span class="n">CHM_SJER</span><span class="p">,</span><span class="w"> </span><span class="s2">"chm_ov_SJER.tiff"</span><span class="p">,</span><span class="w">
            </span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"GTiff"</span><span class="p">,</span><span class="w">
            </span><span class="n">overwrite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
            </span><span class="n">NAflag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-9999</span><span class="p">)</span><span class="w">

</span><span class="c1"># 4.Tree heights are much shorter in SJER.</span><span class="w">
</span><span class="c1"># view histogram of HARV again.</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfcol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">CHM_HARV</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Canopy Height Model - Histogram\nNEON Harvard Forest Field Site"</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"springgreen4"</span><span class="p">,</span><span class="w">
      </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of Pixels"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Elevation (m)"</span><span class="p">)</span><span class="w">

</span><span class="n">hist</span><span class="p">(</span><span class="n">CHM_SJER</span><span class="p">,</span><span class="w">
  </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Canopy Height Model - Histogram\nNEON SJER Field Site"</span><span class="p">,</span><span class="w">
  </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"slategrey"</span><span class="p">,</span><span class="w">
  </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Number of Pixels"</span><span class="p">,</span><span class="w">
  </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Elevation (m)"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-challenge-code-SJER-CHM-5.png" title="plot of chunk challenge-code-SJER-CHM" alt="plot of chunk challenge-code-SJER-CHM" style="display: block; margin: auto;" /></p>
  </blockquote>
</blockquote>

<p>What do these two histograms tell us about the vegetation structure at Harvard
and SJER?</p>


<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li>
</li>
    
  </ul>
</blockquote>

</article>

<div class="row">
  <div class="col-md-1">
    <h3>
      
      <a href="../03-raster-reproject-in-r/"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-md-10">
    
  </div>
  <div class="col-md-1">
    <h3>
      
      <a href="../05-raster-multi-band-in-r/"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      
<footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2016–2018
	
	<a href="http://datacarpentry.org">Data Carpentry</a>
	
      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>
	
	<a href="/edit/gh-pages/_episodes/04-raster-calculations-in-r.md">Edit on GitHub</a>
	
	/
	<a href="/blob/gh-pages/CONTRIBUTING.md">Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob/gh-pages/CITATION">Cite</a>
	/
	<a href="mailto:lessons@software-carpentry.org">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
